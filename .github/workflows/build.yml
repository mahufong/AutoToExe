name: Build Executables

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install PyInstaller
      run: pip install pyinstaller
    
    - name: Build all projects
      run: |
        Write-Host "Building all projects..."
        
        # 获取所有目录
        $directories = Get-ChildItem -Directory
        
        foreach ($dir in $directories) {
            $pyFiles = Get-ChildItem -Path $dir.FullName -Filter "*.py"
            
            if ($pyFiles.Count -gt 0) {
                Write-Host "=== Building $($dir.Name) ==="
                
                # 切换到项目目录
                Set-Location $dir.FullName
                
                # 检查并安装依赖包
                if (Test-Path "requirements.txt") {
                    Write-Host "Installing dependencies from requirements.txt"
                    pip install -r requirements.txt
                }
                
                # 查找主要的Python文件
                if (Test-Path "main.py") {
                    pyinstaller --onefile --name $dir.Name main.py
                } else {
                    # 使用第一个找到的Python文件
                    $firstPyFile = $pyFiles[0].Name
                    pyinstaller --onefile --name $dir.Name $firstPyFile
                }
                
                # 返回上级目录
                Set-Location ..
            }
        }
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: executables
        path: |
          */dist/*.exe